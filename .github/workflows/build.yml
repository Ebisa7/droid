name: Build Release APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  TG_BOT_TOKEN: ${{ secrets.API }}
  TG_CHAT_ID: "6373984454"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="üöÄ *LTQuiz Build Started*%0A%0Aüì± Building Release APK...%0A‚è∞ Started at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
            -d parse_mode="Markdown"

      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚è≥ Setting up Java..." \
            -d parse_mode="Markdown"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚è≥ Setting up Android SDK..." \
            -d parse_mode="Markdown"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 34
          build-tools: 34.0.0

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚úÖ Setup Android SDK%0A‚è≥ Caching Gradle..." \
            -d parse_mode="Markdown"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚úÖ Setup Android SDK%0A‚úÖ Cache Gradle%0A‚è≥ Preparing build..." \
            -d parse_mode="Markdown"

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Clean project
        run: ./gradlew clean

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚úÖ Setup Android SDK%0A‚úÖ Cache Gradle%0A‚úÖ Prepare build%0A‚è≥ Building Release APK..." \
            -d parse_mode="Markdown"

      - name: Build release APK
        id: build_apk
        run: |
          BUILD_LOG=$(mktemp)
          
          # Capture build output and potential errors
          if ! ./gradlew assembleRelease -x lintVitalAnalyzeRelease --stacktrace 2>&1 | tee "$BUILD_LOG"; then
            # Extract key error information
            ERROR_SUMMARY=$(tail -30 "$BUILD_LOG" | grep -E "(error:|Error:|FAILURE:|BUILD FAILED|Exception|Task.*failed)" | head -5 | sed 's/"/\\"/g' | tr '\n' '|')
            echo "error_summary=$ERROR_SUMMARY" >> $GITHUB_OUTPUT
            echo "build_failed=true" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Send progress update
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚úÖ Setup Android SDK%0A‚úÖ Cache Gradle%0A‚úÖ Prepare build%0A‚úÖ Build Release APK%0A‚è≥ Preparing APK for upload..." \
            -d parse_mode="Markdown"

      - name: Get APK info
        if: success()
        id: apk_info
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "‚ùå APK file not found!"
            exit 1
          fi
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          APK_NAME=$(basename "$APK_PATH")
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Found APK: $APK_NAME ($APK_SIZE)"

      - name: Send APK to Telegram
        if: success()
        id: telegram_upload
        run: |
          echo "üì§ Uploading APK to Telegram..."
          
          # Upload APK with timeout and error handling
          UPLOAD_RESPONSE=$(curl -s -w "%{http_code}" -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendDocument" \
            -F chat_id="${{ env.TG_CHAT_ID }}" \
            -F document=@"${{ steps.apk_info.outputs.apk_path }}" \
            -F caption="üéâ *LTQuiz Release APK Built Successfully!*%0A%0Aüì± *APK Details:*%0A‚Ä¢ Name: \`${{ steps.apk_info.outputs.apk_name }}\`%0A‚Ä¢ Size: ${{ steps.apk_info.outputs.apk_size }}%0A‚Ä¢ Version: 1.0 (1)%0A‚Ä¢ Package: com.ltquiz.test%0A%0A‚úÖ Ready to install on Android devices!%0A‚è∞ Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
            -F parse_mode="Markdown" \
            --connect-timeout 30 \
            --max-time 300)
          
          HTTP_CODE="${UPLOAD_RESPONSE: -3}"
          RESPONSE_BODY="${UPLOAD_RESPONSE%???}"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "‚úÖ APK uploaded successfully to Telegram"
            echo "upload_success=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to upload APK to Telegram (HTTP: $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"
            echo "upload_success=false" >> $GITHUB_OUTPUT
            
            # Send fallback notification without APK
            curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ env.TG_CHAT_ID }}" \
              -d text="üéâ *LTQuiz Release APK Built Successfully!*%0A%0Aüì± *APK Details:*%0A‚Ä¢ Name: \`${{ steps.apk_info.outputs.apk_name }}\`%0A‚Ä¢ Size: ${{ steps.apk_info.outputs.apk_size }}%0A‚Ä¢ Version: 1.0 (1)%0A‚Ä¢ Package: com.ltquiz.test%0A%0A‚ö†Ô∏è APK upload failed, but build completed successfully!%0Aüìã Check GitHub Actions artifacts for APK download.%0A‚è∞ Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
              -d parse_mode="Markdown"
          fi

      - name: Upload APK as artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ltquiz-release-apk
          path: ${{ steps.apk_info.outputs.apk_path }}
          retention-days: 30

      - name: Send final status
        if: success()
        run: |
          if [ "${{ steps.telegram_upload.outputs.upload_success }}" = "true" ]; then
            STATUS_TEXT="‚úÖ Upload APK"
          else
            STATUS_TEXT="‚ö†Ô∏è Upload APK (fallback sent)"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="‚úÖ Checkout code%0A‚úÖ Setup Java%0A‚úÖ Setup Android SDK%0A‚úÖ Cache Gradle%0A‚úÖ Prepare build%0A‚úÖ Build Release APK%0A$STATUS_TEXT%0A‚úÖ Upload Artifact%0A%0Aüéâ *Build Completed Successfully!*" \
            -d parse_mode="Markdown"

      - name: Send detailed error notification
        if: failure()
        run: |
          ERROR_TEXT="${{ steps.build_apk.outputs.error_summary }}"
          if [ -n "$ERROR_TEXT" ]; then
            # Replace | with newlines and format for Telegram
            FORMATTED_ERRORS=$(echo "$ERROR_TEXT" | tr '|' '\n' | head -4)
            curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ env.TG_CHAT_ID }}" \
              -d text="‚ùå *Build Failed!*%0A%0Aüîç *Error Details:*%0A\`\`\`%0A$FORMATTED_ERRORS%0A\`\`\`%0A%0Aüìã Check GitHub Actions logs for complete details.%0A‚è∞ Failed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
              -d parse_mode="Markdown"
          else
            curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ env.TG_CHAT_ID }}" \
              -d text="‚ùå *Build Failed!*%0A%0Aüîç Check the GitHub Actions logs for details.%0A‚è∞ Failed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
              -d parse_mode="Markdown"
          fi