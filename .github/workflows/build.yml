name: Build Release APK

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  TG_BOT_TOKEN: ${{ secrets.API }}
  TG_CHAT_ID: "6373984454"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Send start notification
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="ğŸš€ *LTQuiz Build Started*%0A%0AğŸ“± Building Release APK...%0Aâ° Started at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
            -d parse_mode="Markdown"

      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâ³ Setting up Java..." \
            -d parse_mode="Markdown"

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâ³ Setting up Android SDK..." \
            -d parse_mode="Markdown"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 35
          build-tools: 35.0.0

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâœ… Setup Android SDK%0Aâ³ Caching Gradle..." \
            -d parse_mode="Markdown"

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâœ… Setup Android SDK%0Aâœ… Cache Gradle%0Aâ³ Preparing build..." \
            -d parse_mode="Markdown"

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Clean project
        run: ./gradlew clean

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâœ… Setup Android SDK%0Aâœ… Cache Gradle%0Aâœ… Prepare build%0Aâ³ Building Release APK..." \
            -d parse_mode="Markdown"

      - name: Build release APK
        run: ./gradlew assembleRelease -x lintVitalAnalyzeRelease --stacktrace

      - name: Send progress update
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâœ… Setup Android SDK%0Aâœ… Cache Gradle%0Aâœ… Prepare build%0Aâœ… Build Release APK%0Aâ³ Preparing APK for upload..." \
            -d parse_mode="Markdown"

      - name: Get APK info
        id: apk_info
        run: |
          APK_PATH=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          APK_NAME=$(basename "$APK_PATH")
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT

      - name: Send APK to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendDocument" \
            -F chat_id="${{ env.TG_CHAT_ID }}" \
            -F document=@"${{ steps.apk_info.outputs.apk_path }}" \
            -F caption="ğŸ‰ *LTQuiz Release APK Built Successfully!*%0A%0AğŸ“± *APK Details:*%0Aâ€¢ Name: \`${{ steps.apk_info.outputs.apk_name }}\`%0Aâ€¢ Size: ${{ steps.apk_info.outputs.apk_size }}%0Aâ€¢ Version: 1.0 (1)%0Aâ€¢ Package: com.ltquiz.test%0A%0Aâœ… Ready to install on Android devices!%0Aâ° Completed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
            -F parse_mode="Markdown"

      - name: Send final status
        if: success()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âœ… Checkout code%0Aâœ… Setup Java%0Aâœ… Setup Android SDK%0Aâœ… Cache Gradle%0Aâœ… Prepare build%0Aâœ… Build Release APK%0Aâœ… Upload APK%0A%0AğŸ‰ *Build Completed Successfully!*" \
            -d parse_mode="Markdown"

      - name: Send error notification
        if: failure()
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ env.TG_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ env.TG_CHAT_ID }}" \
            -d text="âŒ *Build Failed!*%0A%0AğŸ” Check the GitHub Actions logs for details.%0Aâ° Failed at: $(date '+%Y-%m-%d %H:%M:%S UTC')" \
            -d parse_mode="Markdown"
